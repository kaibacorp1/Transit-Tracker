<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Moderation Queue</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
      background: #fafafa;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #pending {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .item {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .item img {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 1rem;
    }
    .meta {
      flex: 1;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #fff;
    }
    .btn.approve { background: #28a745; }
    .btn.reject  { background: #dc3545; }
  </style>
</head>
<body>
  <h1>Moderation Queue</h1>
  <div id="pending">Loadingâ€¦</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      getDocs,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnPNWITBW92erbxYKLxJaj-s85c1xoiGU",
      authDomain: "transits-9c696.firebaseapp.com",
      projectId: "transits-9c696",
      storageBucket: "transits-9c696.firebasestorage.app",
      messagingSenderId: "83794226858",
      appId: "1:83794226858:web:2cb7f6a8e8f05bd699ead3",
      measurementId: "G-88JRQSFZG5"
    };

    // Initialize Firebase & Firestore
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function loadPending() {
      const container = document.getElementById('pending');
      container.textContent = ''; // clear loading text

      // Query for pending items
      const q = query(
        collection(db, 'gallery'),
        where('status', '==', 'pending'),
        orderBy('uploadedAt', 'asc')
      );

      try {
        const snap = await getDocs(q);
        if (snap.empty) {
          container.textContent = 'No pending uploads.';
          return;
        }

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <img src="${data.url}" alt="Pending photo">
            <div class="meta">
              ${data.title ? `<strong>${data.title}</strong><br>` : ''}
              ${data.dateTaken || ''}<br>
              ${data.location || ''}<br>
              ${data.equipment || ''}
            </div>
            <div class="buttons">
              <button class="btn approve" data-id="${docSnap.id}">Approve</button>
              <button class="btn reject"  data-id="${docSnap.id}">Reject</button>
            </div>
          `;
          container.appendChild(item);
        });

        // Handle button clicks
        container.addEventListener('click', async event => {
          if (!event.target.matches('button')) return;
          const id = event.target.dataset.id;
          const newStatus = event.target.classList.contains('approve') ? 'approved' : 'rejected';
          try {
            await updateDoc(doc(db, 'gallery', id), { status: newStatus });
            // Remove the item from the queue
            event.target.closest('.item').remove();
          } catch (e) {
            console.error('Failed to update status:', e);
          }
        });

      } catch (e) {
        console.error('Error loading pending items:', e);
        container.textContent = 'ðŸš« Failed to load moderation queue.';
      }
    }

    loadPending();
  </script>
</body>
</html>

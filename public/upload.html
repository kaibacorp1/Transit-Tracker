<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Upload to Community Gallery</title>
  <!-- your global stylesheet for colors, typography, etc. -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Layout & spacing onlyâ€”colors come from style.css */
    body {
      font-family: sans-serif;
      margin: 1rem;
      background: var(--bg-secondary);
    }
    .info-message, .consent-box, form {
      background-color: var(--bg-primary);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .info-message {
      border-left: 4px solid var(--color-primary);
    }
    .consent-box {
      border-left: 4px solid var(--color-primary);
      font-size: 0.95rem;
    }
    form label {
      display: block;
      margin-bottom: 0.75rem;
      font-weight: bold;
      color: var(--text-primary);
    }
    input, textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: 4px;
      margin-top: 0.25rem;
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--text-primary);
      font-size: 1rem;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    #uploadBtn {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      background-color: var(--color-primary);
      color: var(--on-primary);
    }
    #uploadBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #uploadBtn:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
    }
    #uploadStatus {
      margin-top: 1rem;
      font-weight: bold;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Info message -->
  <div class="info-message">
    <p>
      Welcome to the Community Transit Gallery! Share your finest Moon and Sun transit photographsâ€”and the story behind themâ€”to inspire fellow enthusiasts.
      Once you submit, our team will review your upload; approved images will appear in the gallery within a few hours.
      Submissions must be strictly transit-related; inappropriate or off-topic content will be declined.
      Please keep each file under 10 MB.
    </p>
  </div>

  <h1>Upload Your Photo</h1>

  <!-- Metadata form -->
  <form id="metaForm">
    <label for="title">Title
      <input type="text" id="title" placeholder="Short description">
    </label>
    <label for="dateTaken">Date Taken
      <input type="date" id="dateTaken">
    </label>
    <label for="location">Location
      <input type="text" id="location" placeholder="City, venue, etc.">
    </label>
    <label for="equipment">Equipment
      <input type="text" id="equipment" placeholder="Camera / lens">
    </label>
    <label for="description">Description
      <textarea id="description" placeholder="Tell us more about your photoâ€¦"></textarea>
    </label>
  </form>

  <!-- Consent box -->
  <div class="consent-box">
    <input type="checkbox" id="agree" />
    <label for="agree">
      I confirm I own this image and grant a non-exclusive license to display it. I have read and agree to the
      <a href="/public/terms.html" target="_blank">Terms of Use</a> and
      <a href="/public/privacy.html" target="_blank">Privacy & Cookies Policy</a>.
    </label>
  </div>

  <!-- Upload button -->
  <button id="uploadBtn" disabled>ðŸ“¤ Upload Photo</button>
  <div id="uploadStatus"></div>

  <!-- Cloudinary widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- Firebase (modular v11) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnPNWITBW92erbxYKLxJaj-s85c1xoiGU",
      authDomain: "transits-9c696.firebaseapp.com",
      projectId: "transits-9c696",
      storageBucket: "transits-9c696.firebasestorage.app",
      messagingSenderId: "83794226858",
      appId: "1:83794226858:web:2cb7f6a8e8f05bd699ead3",
      measurementId: "G-88JRQSFZG5"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Enable Upload button only when consent is given
    const agreeCheckbox = document.getElementById('agree');
    const uploadBtn = document.getElementById('uploadBtn');
    agreeCheckbox.addEventListener('change', e => {
      uploadBtn.disabled = !e.target.checked;
    });

    // Configure Cloudinary widget
    const widget = cloudinary.createUploadWidget({
      cloudName: 'dotbgstrs',
      uploadPreset: 'Transits'
    }, (err, result) => {
      const statusEl = document.getElementById('uploadStatus');
      if (err) {
        statusEl.textContent = 'Upload errorâ€”please check the console.';
        console.error(err);
        return;
      }
      if (result.event === 'success') {
        const url = result.info.secure_url;
        const title       = document.getElementById('title').value;
        const dateTaken   = document.getElementById('dateTaken').value;
        const location    = document.getElementById('location').value;
        const equipment   = document.getElementById('equipment').value;
        const description = document.getElementById('description').value;

        addDoc(collection(db, 'gallery'), {
          url,
          uploadedAt:  serverTimestamp(),
          title,
          dateTaken,
          location,
          equipment,
          description,
          status:      'pending'
        })
        .then(() => {
          statusEl.textContent = 'âœ… Uploaded and pending approval!';
        })
        .catch(e => {
          statusEl.textContent = 'âŒ Error saving data.';
          console.error(e);
        });
      }
    });

    // Open widget when button clicked (only enabled after consent)
    uploadBtn.addEventListener('click', () => {
      widget.open();
    });
  </script>
</body>
</html>

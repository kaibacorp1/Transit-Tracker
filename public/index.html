<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" sizes="512x512" href="/public/favicon.png" />
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7QETEVHGSJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7QETEVHGSJ');
</script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- SEO Essentials -->
<title>Transit Chaser â€“ Predict & Capture Aircraft Transits of the Sun, Moon, and Sky</title>
<meta name="description" content="Transit Chaser helps you capture aircraft transits of the Sun, Moon, contrails, and even plane-on-plane events. Powered by real-time ADS-B data and precise celestial calculations. Free and browser-based.">
<meta name="keywords" content="aircraft transit, sun transit photography, moon plane crossing, ADS-B tracker, contrail tracker, solar transit, lunar transit, plane-on-plane, flight tracking photography, transit chaser app, celestial transit prediction">
<meta name="author" content="Rey Sandu Godakumbura">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://transitchaser.com/" />

  <link rel="stylesheet" href="style.css" />
  <!-- Leaflet Map CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>
  <style>
    /* Nav button styling */
    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #333;
      padding: 0.4rem 0.8rem;
      border: 1px solid #000;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background-color 0.2s;
      line-height: 1;
      cursor: pointer;
      margin: 0;
    }
    .nav-btn:hover {
      background-color: #e0e0e0;
    }
    /* Donate button override */
    .donate-btn {
      background-color: #1a8837;
      color: #fff;
    }
    .donate-btn:hover {
      background-color: #166e2f;
    }
    /* Theme toggle override */
    .theme-toggle {
      background-color: #303d5c;
    }
    .theme-toggle:hover {
      background-color: #b0b0b0;
    }
    /* Header link styling for Upload & Gallery */
    .header-link {
      color: #666;
      text-decoration: none;
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      background-color: #161d2e;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
      cursor: pointer;
    }
    .header-link:hover {
      background-color: #e0e0e0;
      color: #333;
    }
    /* Small-link styling (optional) */
    .small-link {
      font-size: 0.9rem;
      color: #8b7821;
      text-decoration: none;
      margin-bottom: 0.5rem;
      display: inline-block;
    }
    .small-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
      <h1 style="margin: 0;"><span id="trackerTitle">ğŸŒ™ Moon</span> Transits</h1>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <a href="https://youtu.be/JpSmjU9v5QA" target="_blank" class="header-link" style="background-color: #9c983d; padding: 0.25rem 0.5rem; border-radius: 4px;">How to Use</a>
        <a href="/public/upload.html" class="header-link">Upload</a>
        <a href="/public/gallery.html" class="header-link">Gallery</a>
        <a href="https://www.paypal.com/donate/buttons/manage/AFG7SH9Y552KL" target="_blank" class="nav-btn donate-btn">ğŸ«°Donate</a>
        <button id="muteToggleBtn" class="nav-btn theme-toggle" aria-label="Mute/unmute alert sound">ğŸ””</button>
        <button id="themeToggle" class="nav-btn theme-toggle" aria-label="Toggle light/dark mode">ğŸ’¡</button>
      </div>
    </header>

<!-- Add this right below -->
 TransitChaser.com 
<span style="font-size: 0.7rem;">powered by</span>
<a href="https://www.lifebeyondstars.com" class="small-link" target="_blank" rel="noopener noreferrer">
  www.lifebeyondstars.com
</a>


    <div class="highlight" id="transitStatus" style="margin: 1rem 0; font-size: 1.4rem; font-weight: bold;">
    Checking flights near the Moon...
    </div>
    <!-- Line 2: persistent transit log -->
    <div id="transitLogContainer" style="display:none; margin-top:1em;">
  <strong>Log:</strong>
  <ul id="transitLogList" style="padding-left:1.2em;"></ul>

  <!-- Hidden older logs -->
  <div id="extraLogContainer" style="display:none;">
    <ul id="extraLogList" style="padding-left:1.2em; opacity: 0.7;"></ul>
  </div>

  <!-- "Read More" button appears if there are more than 5 entries -->
  <button id="readMoreBtn" style="display:none; margin-top: 0.5em;">ğŸ”½ Read More</button>

  <!-- Existing dismiss button -->
  <button id="dismissLogBtn" style="margin-top: 0.5em;">Dismiss</button>
</div>


    <details id="dataSourceToggle" open>
    <summary>Data Source</summary>
    <div class="data">
      <!-- â€œWhat are these?â€ link inserted right above the tab buttons -->
      <a href="public/providers.html" class="small-link">What are these?</a>

      <div class="tab-buttons">
        <button id="adsboneTabBtn" onclick="showTab('adsboneTab')">ğŸ“¡ ADSB-One</button>
        <button onclick="showTab('openskyTab')" id="openskyTabBtn">âœˆï¸ OpenSky</button>
        <button onclick="showTab('adsbexTab')" id="adsbexTabBtn">ğŸ“¡ ADS-B Exchange</button>
        <button onclick="showTab('radarboxTab')" id="radarboxTabBtn">ğŸ›°ï¸ RadarBox</button>
      </div>

             <div id="adsboneTab" style="display:none; padding:1rem;">
       <h2>ADSB-One</h2>
       <button onclick="useAdsbOneAPI()">ğŸ“¡ Use ADSB-One</button>
       <div id="adsboneApiNotice" style="margin-top:0.5rem;"></div>
       </div>

      <div id="openskyTab">
        <details open>
          <summary><strong>OpenSky Login</strong></summary>
          <p style="font-size: 0.9rem; color: #ccc;">
            You need an account with <a href="https://opensky-network.org/" target="_blank" style="color:#00bfff;">OpenSky Network</a>. Only works with accounts made before 03/2025<br>
            New accounts cannot authenticate via the old Basic-Auth method right now, Weâ€™re in the process of adding OAuth2 support. Please bear with us!
          </p>
          <label>Username: <input type="text" id="osUsername" /></label><br>
          <label>Password: <input type="password" id="osPassword" /></label><br>
          <button onclick="saveCredentials()">ğŸ” Save Credentials</button>
          <small>We do not store your credentials. Used only this session.</small>
        </details>
      </div>

      <div id="adsbexTab" style="display:none;">
        <details open>
          <summary><strong>ADS-B Exchange</strong></summary>
          You need an account with <a href="https://rapidapi.com/hub" target="_blank" style="color:#00bfff;">Rapidapi.com</a>.<br>
          <label>ğŸ”‘ RapidAPI Key:</label>
          <input type="text" id="adsbApiKey" placeholder="Enter your RapidAPI Key" style="width:100%;" />
          <label>ğŸŒ API Host:</label>
          <input type="text" id="adsbApiHost" value="adsbexchange-com1.p.rapidapi.com" style="width:100%;" />
          <button onclick="saveAdsbExSettings()">ğŸ’¾ Save Settings</button>
          <button onclick="useAdsbExchangeAPI()" style="margin-top:0.5rem;">ğŸ“¡ Use ADS-B Exchange</button>
          <div id="adsbApiNotice"></div>
        </details>
      </div>

       <div id="radarboxTab" style="display:none; padding:1rem">
       <h2>Coming soon </h2>
       <label for="radarboxKeyInput">API Token:</label>
       <input id="radarboxKeyInput" type="text" placeholder="Enter your RadarBox token" />
      <button onclick="saveRadarboxKey()">ğŸ’¾ Save Token</button>
      <span id="radarboxApiNotice" style="margin-left:1rem"></span>
       <hr style="margin:1rem 0" />
       <button onclick="useRadarboxAPI()">ğŸ›°ï¸ Use RadarBox</button>
      </div>
    </div>
      </details>

    <details id="locationModeToggle" open>
  <summary><strong>ğŸ“</strong></summary>
  <div class="data">
    <label><strong>Location Mode:</strong></label>
    <select id="locationMode">
      <option value="auto" selected>Auto (GPS)</option>
      <option value="manual">Manual</option>
    </select>
    <button id="refreshBtn" style="margin-left:1rem;">ğŸ”„ Refresh</button>
    <div id="manualLocationFields" style="display:none; margin-top:0.5rem;">
      <br />
      <button onclick="showMap()" style="margin-top: 0.5rem;">ğŸ—ºï¸ Select from Map</button>
      <div id="locationErrorMsg" style="display:none; color: orange; font-size: 0.85em; margin-top: 5px;"></div>
      <div id="mapContainer" style="height: 300px; margin-top: 1rem; display: none; border: 1px solid #444;"></div><br />
      <label>Latitude: <input id="manualLat" type="number" step="0.000001" /></label><br />
      <label>Longitude: <input id="manualLon" type="number" step="0.000001" /></label><br />
      <label>Elevation (m): <input id="manualElev" type="number" value="10" /></label>
    </div>
  </div>
</details>



        <div class="data">
      <div class="controls">
        <label><strong>Transit Mode:</strong></label>
        <select id="bodyToggle">
          <option value="moon">ğŸŒ™ Moon</option>
          <option value="sun">â˜€ï¸ Sun</option>
          <option value="plane on plane">âœˆï¸ on âœˆï¸</option>
          <option value="plane contrails">âœˆï¸ğŸ’¨ğŸ’¨</option>
        </select>
        <label><strong>Search Radius:</strong></label>
        <select id="radiusSelect">
          <option value="10">10 km</option>
          <option value="20">20 km</option>
          <option value="30" selected>30 km</option>
          <option value="40">40 km</option>
          <option value="50">50 km</option>
          <option value="60">60 km</option>
        </select>
        <label><strong>Prediction:</strong></label>
        <select id="predictToggle">
          <option value="0">Off</option>
          <option value="30">30 sec</option>
          <option value="60">60 sec</option>
          <option value="120" selected>120 sec</option>
          <option value="180">180 sec</option>
        </select>
        <label><strong>Auto Refresh:</strong></label>
        <select id="autoRefreshToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
  <span id="countdownTimer">Next check in: 5s</span>
</div>
    </div>

<div class="data">
  <label style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
    <div style="display: flex; gap: 0.75rem; align-items: center;">
      <strong>Detection Margin</strong>
      <a href="public/detection_visuals.html" class="small-link" style="font-size: 0.85rem;">Visuals</a>
    </div>
    <div style="display: flex; flex-direction: column; align-items: flex-end;">
      <button
        id="enhancedPredictionBtn"
        onclick="toggleEnhancedPrediction()"
        style="background-color: #66252f; color: white; border: none; padding: 0.4rem 1rem; font-weight: bold; font-size: 0.95rem; border-radius: 8px; cursor: pointer;"
      >
        ğŸ”´ Enhanced Prediction
      </button>
      <a href="https://transitchaser.com/public/EnhancedPrediction.html" class="small-link" style="font-size: 0.8rem; margin-top: 0.2rem;">Whatâ€™s this?</a>
          </div>
  </label>
  <input id="marginSlider" type="range" min="0.5" max="200" step="0.5" value="2.5" />
  <span id="marginValue">2.5Â°</span>
  <div id="marginFeedback">ğŸŒŸ Very strict (photography)</div>
  <input type="checkbox" id="enhancedPrediction" checked style="display:none;" />
</div>


    <div class="data" id="locationInfo">
      <strong>Your Location &amp; <span id="bodyLabel">Moon</span> Info:</strong>
      <div class="info-grid">
        <div>
          <div>Latitude: <span id="lat">...</span></div>
          <div>Longitude: <span id="lon">...</span></div>
          <div>Elevation: <span id="elevation">...</span> m</div>
        </div>
        <div>
          <div>Azimuth: <span id="moonAz">...</span>Â°</div>
          <div>Altitude: <span id="moonAlt">...</span>Â°</div>
        </div>
      </div>
    </div>

    <div class="data">
      <details>
        <summary><strong>âš™ï¸ Advanced Settings</strong></summary><br>
        <button id="viewLogBtn">ğŸ•’ View Transit Log</button>
        <button id="clearLogBtn">ğŸ—‘ï¸ Clear Log</button>
        <button id="downloadLogBtn">ğŸ“¥ Download Log</button><br><br>
        <label><strong>Log Format:</strong>
          <select id="logFormat">
            <option value="txt" selected>Plain Text (.txt)</option>
            <option value="json">JSON (.json)</option>
          </select>
        </label><br>
        <br>
        <label>ğŸ” Auto Refresh Interval (sec):
          <input id="refreshIntervalInput" type="number" min="3" style="width:60px" value="5" />
        </label><br>
        <label for="volumeSlider">ğŸ”Š Volume:</label>
       <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" />
       <br />
    </details>
    </div>

    <audio id="alertSound" preload="auto" src="/alert.MP3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <script src="scripts/script.js"></script>

    <footer>
      <p>Copyright Â© Rey Sandu Godakumbura</p>
      <p>
        <a href="/public/reports.html">Help us</a> |
        <a href="/public/aboutus.html">About Us</a> |
        <a href="https://www.lifebeyondstars.com/about-me" target="_blank">About Creator</a> |
        <a href="/public/terms.html">Terms of Use</a> |
        <a href="/public/privacy.html">Privacy & Cookies</a> |
        <a href="LICENSE.txt">License</a> |
        <a href="mailto:sandu.godakumbura@gmail.com">Contact</a> |
        <a href="public/how_to_use.html">How to Use</a> 
      </p>
    </footer>

    <!-- Modal HTML -->
<div id="alertModal" style="
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex; align-items: center; justify-content: center;
">
  <div style="
    background: rgb(73, 73, 73);
    padding: 1.5rem 2rem;
    max-width: 500px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    text-align: center;
    font-family: sans-serif;
  ">
    <h2 style="margin-top: 0;">Volume Reminder ğŸ”ˆ</h2>
    <p>
      A loud alert will sound when an aircraft is detected.<br>
      Please adjust your volume now to avoid surprises.
    </p>
    <button onclick="document.getElementById('alertModal').style.display='none'" style="
      margin-top: 1rem;
      padding: 0.5rem 1.2rem;
      border: none;
      background-color: #2b5127;
      color: rgb(211, 211, 211);
      border-radius: 6px;
      cursor: pointer;
    ">Got it</button>
  </div>
</div>
    <!--
Drop this whole chunk near the bottom of your existing index.html (above your closing </body>)
It adds a toggleable visual panel and a tiny renderer that listens for your existing
`callTransitAPI` results via a custom event weâ€™ll dispatch from script.js.
-->

<!-- SKYVIZ (no changes to script.js needed) -->
<!-- SKYVIZ (real sky view; no changes to script.js needed) -->
<section id="skyviz-wrap" style="margin:14px 0 0 0">
  <style>
    #skyviz-wrap{border:1px solid #233044;border-radius:14px;overflow:hidden;background:#0b0f14}
    #skyviz-head{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#141a22;color:#c9d7ef;flex-wrap:wrap}
    #skyviz-head .spacer{flex:1}
    #skyviz{display:block;width:100%;height:360px;background:radial-gradient(900px 640px at 50% 70%,#0f1620,#0b0f14); cursor:crosshair}
    #skyviz-panel{position:relative}
    #skyviz-hud{position:absolute;left:12px;top:56px;padding:8px 10px;background:#0f1620cc;border:1px solid #203040;border-radius:10px;color:#8aa0b7}
    .label{color:#8aa0b7}
    .btn{border:1px solid #2a3950;background:#182131;color:#c9d7ef;border-radius:6px;padding:4px 8px;cursor:pointer}
    .btn:active{transform:scale(0.98)}
  </style>

  <div id="skyviz-head">
    <label class="label" style="display:inline-flex;align-items:center;gap:6px">
      <input type="checkbox" id="skyviz-enable" /> Enable visual panel
    </label>

    <div class="spacer"></div>

    <div class="label" style="display:inline-flex;align-items:center;gap:8px">
      Zoom
      <button id="skyviz-zoom-out" class="btn">âˆ’</button>
      <span id="skyviz-zoomval">100%</span>
      <button id="skyviz-zoom-in" class="btn">+</button>
    </div>

    <label class="label" style="display:inline-flex;align-items:center;gap:6px">
      Target
      <select id="skyviz-target" style="min-width:160px">
        <option value="">Auto (closest)</option>
      </select>
    </label>

    <label class="label" style="display:inline-flex;align-items:center;gap:6px">
      Margin
      <input id="skyviz-margin" type="range" min="0.5" max="30" step="0.5" value="2.5" style="width:140px" />
      <span id="skyviz-margin-val">2.5Â°</span>
    </label>
  </div>

  <div id="skyviz-panel" style="display:none">
    <canvas id="skyviz" title="Scroll to zoom, double-click to reset"></canvas>
    <div id="skyviz-hud"><div id="skyviz-readout" style="white-space:nowrap"></div></div>
  </div>
</section>

<script>
(function(){
  // --- DOM
  const enable = document.getElementById('skyviz-enable');
  const panel  = document.getElementById('skyviz-panel');
  const canvas = document.getElementById('skyviz');
  const ctx    = canvas.getContext('2d');
  const readout= document.getElementById('skyviz-readout');
  const bodySel= document.getElementById('bodyToggle');    // your existing selector (moon/sun)
  const zInBtn = document.getElementById('skyviz-zoom-in');
  const zOutBtn= document.getElementById('skyviz-zoom-out');
  const zLabel = document.getElementById('skyviz-zoomval');
  const targetSel= document.getElementById('skyviz-target');
  const vizMarginIn = document.getElementById('skyviz-margin');
  const vizMarginVal= document.getElementById('skyviz-margin-val');
  const mainMargin  = document.getElementById('marginSlider');

  // Persist on/off
  const KEY = 'skyviz_enabled';
  enable.checked = localStorage.getItem(KEY) === '1';
  panel.style.display = enable.checked ? 'block' : 'none';
  enable.addEventListener('change', ()=>{
    localStorage.setItem(KEY, enable.checked ? '1' : '0');
    panel.style.display = enable.checked ? 'block' : 'none';
    size(); draw();
  });

  // Canvas size
  function size(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    canvas.width = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(360 * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', size, {passive:true});
  size();

  // Apparent radius of Sun/Moon ~0.25Â° (so 1Â° â‰ˆ 4 radii)
  const ANGULAR_RADIUS_DEG = 0.25;

  // --- State
  const state = {
    bodyKind: (bodySel?.value === 'moon') ? 'moon' : 'sun',
    zoom: 1.0,                          // 0.05â€“10
    marginDeg: parseFloat(mainMargin?.value) || 2.5,
    matches: [],
    selectedId: "",                     // "" = auto
    // interpolation & dead-reckon in 2D (Î”az, Î”alt)
    cur:  { relAz: 0, relAlt: 0, hasData:false },
    next: { relAz: 0, relAlt: 0 },
    t0: performance.now(),
    t1: performance.now(),
    relAzRate: 0,   // deg/s
    relAltRate: 0   // deg/s
  };

  // --- Helpers
  const wrap = d => ((d+540)%360)-180;
  const lerp = (a,b,t)=> a+(b-a)*t;
  const lerpDeg = (a0,a1,t)=> a0 + wrap(a1-a0)*t;

  function center(){ return { cx: Math.round(canvas.clientWidth*0.5), cy: Math.round(canvas.clientHeight*0.62) }; }
  function bodyRadiusPx(){ return (state.bodyKind==='sun'?56:36); }
  function pxPerDeg(){ return bodyRadiusPx() / ANGULAR_RADIUS_DEG; } // 1Â° = 4 radii

  function refreshSeconds(){
    const el = document.getElementById('refreshIntervalInput');
    const v = parseFloat(el && el.value);
    return (!isNaN(v) && v >= 1) ? v : 5;
  }

  // Zoom
  function setZoom(z){
    state.zoom = Math.min(10, Math.max(0.05, z)); // 5%..1000%
    zLabel.textContent = `${Math.round(state.zoom*100)}%`;
    draw();
  }
  setZoom(1.0);
  zInBtn.addEventListener('click', ()=> setZoom(state.zoom*1.2));
  zOutBtn.addEventListener('click', ()=> setZoom(state.zoom/1.2));
  canvas.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const dir = e.deltaY < 0 ? 1 : -1;
    setZoom(state.zoom * (1 + dir*0.12));
  }, {passive:false});
  canvas.addEventListener('dblclick', ()=> setZoom(1.0));

  // Margin sync both ways (Viz <-> main)
  function setMargin(v){
    state.marginDeg = v;
    vizMarginIn.value = String(v);
    vizMarginVal.textContent = `${v.toFixed(1)}Â°`;
    if (mainMargin && Math.abs(parseFloat(mainMargin.value)-v)>0.001){
      mainMargin.value = String(v);
      mainMargin.dispatchEvent(new Event('input',{bubbles:true}));
    }
    draw();
  }
  setMargin(state.marginDeg);
  vizMarginIn.addEventListener('input', ()=> setMargin(parseFloat(vizMarginIn.value)||2.5));
  mainMargin?.addEventListener('input', ()=> setMargin(parseFloat(mainMargin.value)||2.5));

  // Body toggle
  bodySel?.addEventListener('change', ()=>{
    state.bodyKind = (bodySel.value === 'moon') ? 'moon' : 'sun';
    draw();
  });

  // Sun/Moon az & alt from SunCalc (viewer perspective)
  function currentBodyAzAlt(){
    try {
      const u = window.userCoords; if (!u) return {az:0, alt:0};
      const now = new Date();
      const pos = (state.bodyKind==='moon')
        ? SunCalc.getMoonPosition(now, u.lat, u.lon)
        : SunCalc.getPosition(now, u.lat, u.lon);
      return {
        az:  (pos.azimuth * 180/Math.PI) + 180, // [0..360)
        alt:  pos.altitude * 180/Math.PI        // degrees
      };
    } catch {
      return {az:0, alt:0};
    }
  }

  // Interpolation / dead-reckon in 2D (relAz, relAlt)
  function currentInterpolatedSky(){
    const now = performance.now();
    if(!state.cur.hasData) return { relAz: state.next.relAz || 0, relAlt: state.next.relAlt || 0 };
    if (now <= state.t1){
      const t = (state.t1===state.t0) ? 1 : Math.min(1, Math.max(0,(now-state.t0)/(state.t1-state.t0)));
      return {
        relAz:  lerpDeg(state.cur.relAz,  state.next.relAz,  t),
        relAlt: lerp(   state.cur.relAlt, state.next.relAlt, t)
      };
    }
    // dead-reckon (cap ~2Ã— refresh)
    const dt = Math.min(refreshSeconds()*2000, now - state.t1)/1000;
    return {
      relAz:  state.next.relAz  + state.relAzRate*dt,
      relAlt: state.next.relAlt + state.relAltRate*dt
    };
  }

  // Backdrop + body + margin ring
  function drawBackdrop(){
    ctx.globalAlpha = 0.2;
    for(let i=0;i<24;i++){
      const x=Math.random()*canvas.clientWidth, y=40+Math.random()*(canvas.clientHeight-40);
      ctx.fillStyle='#93a7bd'; ctx.fillRect(x,y,1,1);
    }
    ctx.globalAlpha = 1;
  }
  function drawBody(){
    const r = bodyRadiusPx();
    if(state.bodyKind==='sun'){
      const grad = ctx.createRadialGradient(0,0, r*0.2, 0,0, r);
      grad.addColorStop(0,'#fff3b0'); grad.addColorStop(1,'#e5a93b');
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
      ctx.shadowColor = '#ffd166'; ctx.shadowBlur = 18; ctx.globalAlpha=0.55;
      ctx.beginPath(); ctx.arc(0,0,r*1.25,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; ctx.shadowBlur=0;
    } else {
      ctx.fillStyle = '#cfd7e3'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#b9c3d1'; ctx.globalAlpha=0.4;
      for(let i=0;i<5;i++){ const a=Math.random()*Math.PI*2, rr=3+Math.random()*5; ctx.beginPath(); ctx.arc(Math.cos(a)*r*0.6, Math.sin(a)*r*0.6, rr, 0, Math.PI*2); ctx.fill(); }
      ctx.globalAlpha=1;
    }
    // margin ring in true degrees
    const ringR = r + state.marginDeg * pxPerDeg();
    ctx.save(); ctx.setLineDash([6,6]); ctx.lineWidth = 2; ctx.strokeStyle = '#375a8a';
    ctx.beginPath(); ctx.arc(0,0, ringR, 0, Math.PI*2); ctx.stroke(); ctx.restore();
  }

  // Plane drawing (uses Î”az, Î”alt â†’ screen X/Y)
  function drawPlaneSky(relAzDeg, relAltDeg){
    const x =  relAzDeg * pxPerDeg();  // right is +az
    const y = -relAltDeg * pxPerDeg(); // up is +alt â†’ negative y

    // look-ahead for nose direction
    const dt = 0.30;
    const x2 = (relAzDeg + state.relAzRate*dt)  * pxPerDeg();
    const y2 =-(relAltDeg + state.relAltRate*dt)* pxPerDeg();
    const ang = Math.atan2(y2 - y, x2 - x);

    ctx.save(); ctx.translate(x, y); ctx.rotate(ang);

    // airplane silhouette
    const s = 12;
    const p = new Path2D();
    // fuselage
    p.moveTo( 0.95*s,  0);
    p.quadraticCurveTo( 0.35*s, -0.14*s, -0.90*s, -0.05*s);
    p.lineTo(-0.90*s,  0.05*s);
    p.quadraticCurveTo( 0.35*s,  0.14*s,  0.95*s, 0);
    p.closePath();
    // wing top
    p.moveTo( 0.08*s, -0.02*s);
    p.lineTo(-0.25*s, -0.26*s);
    p.lineTo(-0.05*s, -0.26*s);
    p.lineTo( 0.26*s, -0.02*s);
    p.closePath();
    // wing bottom
    p.moveTo( 0.08*s,  0.02*s);
    p.lineTo(-0.25*s,  0.26*s);
    p.lineTo(-0.05*s,  0.26*s);
    p.lineTo( 0.26*s,  0.02*s);
    p.closePath();
    // tail
    p.moveTo(-0.62*s,  0);
    p.lineTo(-0.92*s, -0.16*s);
    p.lineTo(-0.80*s,  0);
    p.lineTo(-0.92*s,  0.16*s);
    p.closePath();

    ctx.fillStyle = '#9bd7ff';
    ctx.strokeStyle = '#82bfe6';
    ctx.lineWidth = 1;
    ctx.fill(p);
    ctx.stroke(p);
    ctx.restore();
  }

  // Main draw
  function draw(){
    if(panel.style.display === 'none') return;

    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    drawBackdrop();

    const { cx, cy } = center();
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(state.zoom, state.zoom);

    drawBody();

    const v = currentInterpolatedSky();
    drawPlaneSky(v.relAz, v.relAlt);

    ctx.restore();

    const sepNow = Math.hypot(v.relAz, v.relAlt);
    const inside = sepNow <= state.marginDeg;
    readout.innerHTML = `${state.bodyKind==='moon'?'ğŸŒ™':'â˜€ï¸'} Sep â‰ˆ <b>${sepNow.toFixed(1)}Â°</b> ${inside? 'Â· <span style="color:#5ee27b">inside margin</span>':''}`;
  }
  function frame(){ if(enable.checked) draw(); requestAnimationFrame(frame); }
  requestAnimationFrame(frame);

  // Target dropdown helpers
  function mId(m){ return (m.callsign?.trim() || m.hex?.trim() || `${m.azimuth||''}/${m.latitude||''}/${m.longitude||''}`); }
  function mLabel(m){
    const az  = Number(m.azimuth)||0;
    const alt = Number(m.altitudeAngle ?? m.altitude ?? m.elevationAngle ?? 0);
    return `${(m.callsign || m.hex || 'UNKNOWN')} Â· az ${az.toFixed(0)}Â° Â· alt ${alt.toFixed(0)}Â°`;
  }
  function rebuildTargetDropdown(){
    const prev = state.selectedId || targetSel.value || "";
    targetSel.innerHTML = '<option value="">Auto (closest)</option>';
    // Sort by smallest true separation (Î”az, Î”alt) if we can; fall back to provided separation
    const body = currentBodyAzAlt();
    const scored = state.matches.map(mm=>{
      const paz = Number(mm.azimuth)||0;
      const pal = Number(mm.altitudeAngle ?? mm.altitude ?? mm.elevationAngle ?? 0);
      const relAz = Math.abs(wrap(paz - body.az));
      const relAlt= Math.abs(pal - body.alt);
      const sep = Math.hypot(relAz, relAlt);
      return { mm, sep };
    }).sort((a,b)=> a.sep - b.sep);

    for (const { mm } of scored) {
      const id = mId(mm);
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = mLabel(mm);
      targetSel.appendChild(opt);
    }
    if ([...targetSel.options].some(o=>o.value===prev)){
      targetSel.value = prev; state.selectedId = prev;
    } else { targetSel.value = ""; state.selectedId = ""; }
  }
  targetSel.addEventListener('change', ()=>{
    state.selectedId = targetSel.value; // "" = auto
    // soft snap from current visual pos
    const curV = currentInterpolatedSky();
    state.cur.relAz = curV.relAz; state.cur.relAlt = curV.relAlt; state.cur.hasData = true;
    state.t0 = performance.now(); state.t1 = state.t0 + refreshSeconds()*1000;
  });

  // Handle detections from your app (no changes required to script.js)
  window.addEventListener('transit:matches', (e)=>{
    if(panel.style.display === 'none' || !enable.checked) return;

    const d = e.detail || {};
    state.bodyKind = (d.selectedBody === 'moon') ? 'moon' : 'sun';
    state.matches = Array.isArray(d.matches) ? d.matches.slice() : [];
    rebuildTargetDropdown();

    // choose selected or auto-closest (by true angular sep using body az/alt now)
    const body = currentBodyAzAlt();
    let chosen = null;
    if (state.selectedId) {
      chosen = state.matches.find(mm => mId(mm) === state.selectedId) || null;
    }
    if (!chosen){
      chosen = state.matches
        .map(mm => {
          const paz = Number(mm.azimuth)||0;
          const pal = Number(mm.altitudeAngle ?? mm.altitude ?? mm.elevationAngle ?? 0);
          const relAz = wrap(paz - body.az);
          const relAlt= pal - body.alt;
          return { mm: mm, sep: Math.hypot(relAz, relAlt), relAz, relAlt };
        })
        .sort((a,b)=> a.sep - b.sep)[0]?.mm || null;
    }
    if(!chosen){ state.cur.hasData=false; draw(); return; }

    // compute relAz/relAlt for the chosen plane
    const planeAz  = Number(chosen.azimuth)||0;
    const planeAlt = Number(chosen.altitudeAngle ?? chosen.altitude ?? chosen.elevationAngle ?? 0);
    const relAz    = wrap(planeAz - body.az);
    const relAlt   = planeAlt - body.alt;

    // smooth transition & dead-reckon setup
    const now = performance.now();
    const curV = currentInterpolatedSky();

    state.cur.relAz  = curV.relAz;
    state.cur.relAlt = curV.relAlt;
    state.cur.hasData = true;

    state.next.relAz  = relAz;
    state.next.relAlt = relAlt;

    const dur = refreshSeconds()*1000;
    state.t0 = now; state.t1 = now + dur;

    state.relAzRate  = wrap(state.next.relAz - state.cur.relAz) / (dur/1000 || 1);
    state.relAltRate = (state.next.relAlt - state.cur.relAlt) / (dur/1000 || 1);
  });

  // Initial draw
  draw();
})();
</script>



  </div>
</body>
</html>
